<!DOCTYPE html>
<html>
	<head>
		<title>
			Spyfall X
		</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="/styles/variables.css">

		<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
		<link rel="manifest" href="/icons/site.webmanifest">
		<link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5">
		<link rel="shortcut icon" href="/icons/favicon.ico">
		<meta name="msapplication-TileColor" content="#ffc40d">
		<meta name="msapplication-config" content="/icons/browserconfig.xml">
		<meta name="theme-color" content="#ffffff">

	</head>
	<body data-username-filled=false data-error=false data-first-choice=true data-enter-game-id=false>
		<h1>Spyfall X</h1>

		<div>
			<a href="about.html">About/Rules</a>
		</div>

		<hr>

		<div class="form">
			<label>
				<span class=label-text>
					Your name:
				</span>
				<input type="text" placeholder="Totally not a spy" id="player-name" autofocus>
			</label>

			<div data-when=first-choice>
				<div class="center-row" >
					<button type=button id=choose-location>Create New Game...</button>
					<button type=button id=enter-game-id>Join Game...</button>
				</div>
			</div>

			<div data-when=choose-location>
				<div class="center-row">
					<button type=button id=back class=gray>Back</button>
				</div>

				<label>
					<span class="label-text">
						Choose a set of locations:
					</span>
				</label>
				<div class="center-row">
					<button type=button id=create-game-location1>
						<span class=emoji>1️⃣</span>
						Original locations
					</button>
					<button type=button id=create-game-location2>
						<span class=emoji>2️⃣</span>
						Spyfall 2 locations
					</button>
				</div>
			</div>

			<div data-when=enter-game-id>
				<div class="center-row">
					<button type=button id=back class=gray>Back</button>
				</div>

				<label>
					<span class="label-text">
						Enter the game code:
					</span>
					<input type="text" placeholder="vwxyz" id=game-id>
				</label>
				<div class="center-row">
					<button type=button id=join-game>Join Game</button>
				</div>
			</div>
		</div>

		<div id=error-message data-when=error class="center">

		</div>

		<div class="relevant-ad">
			Your friends and family need good games.  Buy Spyfall for them:
			<div class="buy-game-links">
				<a href="https://www.amazon.com/gp/product/B00Y4TYRT8/ref=as_li_tl?ie=UTF8&tag=spyfallx-20&camp=1789&creative=9325&linkCode=as2&creativeASIN=B00Y4TYRT8&linkId=44ed4c0f1a58af355190bb47fe303e84">
					<img src="images/spyfall.jpg" alt="Spyfall">
					Spyfall
				</a>
				<a href="https://www.amazon.com/gp/product/B01MRVIURU/ref=as_li_tl?ie=UTF8&tag=spyfallx-20&camp=1789&creative=9325&linkCode=as2&creativeASIN=B01MRVIURU&linkId=2df99540d7c31ea39b76d1eeb3e9d057">
					<img src="images/spyfall2.jpg" alt="Spyfall 2">
					Spyfall 2
				</a>
				<a href="https://www.amazon.com/gp/product/B078HTBQYJ/ref=as_li_tl?ie=UTF8&tag=spyfallx-20&camp=1789&creative=9325&linkCode=as2&creativeASIN=B078HTBQYJ&linkId=d82c65a94d959b27ecb0fb4599fbde99">
					<img src="images/dcspyfall.jpg" alt="DC Spyfall">
					DC Spyfall
				</a>
			</div>
		</div>

		<div class="footer">
			<img src="images/duff.svg" alt="Duff logo">
			<span>
				This is a Josh Duff site.  To help it stick around and be maintained, <a href="https://www.patreon.com/TehShrike">support me on Patreon.</a>
			</span>
		</div>

		<style>
			.form {
				display: flex;
				flex-direction: column;
				align-items: stretch;
				justify-content: space-around;
			}

			.form label {
				margin-bottom: 16px;
			}

			.center-row {
				display: flex;
				justify-content: space-evenly;
				align-items: stretch;
			}
			.center-row > * {
				flex-grow: 1;
				flex-basis: 100%;
			}

			hr {
				flex-grow: 1;
			}

			.form label {
				display: flex;
				flex-direction: column;
				align-items: stretch;
			}
			.form label input {
				flex-grow: 1;
			}

			.label-text {
				padding-top: 8px;
				padding-bottom: 4px;
			}

			.form button {
				margin: 8px;
				max-width: 400px;
				min-width: 230px;
			}
			.form button:first-child {
				margin-left: 0;
			}
			.form button:last-child {
				margin-right: 0;
			}

			.emoji {
				font-weight: 400;
				font-family: apple color emoji,segoe ui emoji,notocoloremoji,android emoji,emojisymbols,emojione mozilla,segoe ui symbol;
				font-size: 24px;
				padding-right: 16px;
			}


			@media (max-width: 500px) {
				.center-row {
					flex-direction: column;
					align-items: center;
				}
				.center-row button {
					margin-left: 0;
					margin-right: 0;
					width: 100%;
				}
			}

			.relevant-ad {
				margin-top: 32px;
				color: var(--lightBlack);
			}
			.buy-game-links {
				list-style: none;
				margin-top: 8px;

				display: flex;
				flex-direction: row;
				justify-content: space-evenly;
			}
			.buy-game-links img {
				max-height: 120px;
			}
			.buy-game-links a {
				display: flex;
				flex-direction: column;
				align-items: center;

				margin: 8px;
			}
			@media (max-width: 500px) {
				.buy-game-links img {
					max-height: 100px;
				}
			}
			@media (max-width: 350px) {
				.buy-game-links {
					flex-wrap: wrap;
				}
				.buy-game-links img {
					max-height: 140px;
					max-width: 90%;
				}
			}


			[data-when] {
				display: none;
			}

			[data-error=true] [data-when=error] {
				display: block;
			}

			[data-first-choice=true] [data-when=first-choice] {
				display: block;
			}

			[data-choose-location=true] [data-when=choose-location] {
				display: block;
			}

			[data-enter-game-id=true] [data-when=enter-game-id] {
				display: block;
			}
		</style>


		<script type=module>
			import { post } from './futch.js'
			import { PLAYER_NAME_KEY } from './constants.js'
			import getPlayerDeetz from './get-player-deetz.js'
			import makeErrorHandler from './handle-error.js'

			const handleError = makeErrorHandler(document.getElementById(`error-message`))

			const body = document.body

			const CREATE_GAME_LOCATION1 = `create-game-location1`
			const CREATE_GAME_LOCATION2 = `create-game-location2`
			const ENTER_GAME_ID_BUTTON_ID = `enter-game-id`
			const CHOOSE_LOCATIONS_ID = `choose-location`
			const JOIN_GAME_BUTTON_ID = `join-game`
			const NAME_INPUT_ID = `player-name`
			const GAME_ID_INPUT_ID = `game-id`

			const playerNameElement = document.getElementById(NAME_INPUT_ID)

			const postWithErrorHandling = (...args) => handleError(post(...args))

			const on = (id, event, fn) => {
				const e = document.getElementById(id)
				e.addEventListener(event, fn)
				return () => e.removeEventListener(event, fn)
			}

			const init = async() => {
				const initialPlayerName = localStorage.getItem(PLAYER_NAME_KEY)

				const updateUsernameFilled = () => {
					body.dataset.usernameFilled = !!playerNameElement.value
				}

				if (initialPlayerName) {
					console.log(`Found saved player name`, initialPlayerName)
					playerNameElement.value = initialPlayerName
					updateUsernameFilled()
				}
				playerNameElement.addEventListener(`input`, updateUsernameFilled)

				window.addEventListener(`unhandledrejection`, event => {
					console.error(event.reason)
				})
			}

			const playerDeetzPromise = handleError(getPlayerDeetz())


			const createGameId = async locationId => {
				const { playerSecret } = await playerDeetzPromise
				const { gameId } = await postWithErrorHandling(`/api/create`, {
					playerSecret,
					locationId,
				})

				return gameId
			}

			const setNameAndNavigateToGame = async({ gameId }) => {
				const { playerSecret } = await playerDeetzPromise

				const playerNameValue = playerNameElement.value

				if (playerNameValue) {
					console.log(`setting name to`, playerNameElement.value)

					localStorage.setItem(PLAYER_NAME_KEY, playerNameElement.value)

					await postWithErrorHandling(`/api/set-name`, {
						name: playerNameElement.value,
						playerSecret,
					})
				}

				document.location = `game.html?gameId=${ gameId.toLowerCase() }`
			}

			const createGameListener = (id, locationId) => {
				on(id, `click`, async() => {
					await setNameAndNavigateToGame({
						gameId: await createGameId(locationId),
					})
				})
			}

			createGameListener(CREATE_GAME_LOCATION1, `1`)
			createGameListener(CREATE_GAME_LOCATION2, `2`)


			on(JOIN_GAME_BUTTON_ID, `click`, async() => {
				const gameId = document.getElementById(GAME_ID_INPUT_ID).value

				await setNameAndNavigateToGame({
					gameId,
				})
			})

			on(ENTER_GAME_ID_BUTTON_ID, `click`, async() => {
				body.dataset.firstChoice = false
				body.dataset.enterGameId = true

				document.getElementById(GAME_ID_INPUT_ID).focus()
			})

			on(CHOOSE_LOCATIONS_ID, `click`, async() => {
				body.dataset.firstChoice = false
				body.dataset.chooseLocation = true
			})

			on(`back`, `click`, async() => {
				body.dataset.firstChoice = true
				body.dataset.enterGameId = false
				body.dataset.chooseLocation = false
			})

			init()
		</script>

		<link rel="stylesheet" href="/styles/basic.css">

		<script async src="https://cdn.simpleanalytics.io/hello.js"></script>
		<noscript><img src="https://api.simpleanalytics.io/hello.gif" alt=""></noscript>
	</body>
</html>
